# Get the array of siblings for a taxon
# Results are limited to 10k
name: ncbi_taxon_get_siblings
params:
  type: object
  required: [id, ts]
  properties:
    id:
      type: string
      title: Document id
      description: ID of the taxon vertex for which you want to find siblings
    limit:
      type: integer
      default: 20
      description: Maximum result limit
      maximum: 1000
    offset:
      type: integer
      default: 0
      description: Result offset for pagination
      maximum: 100000
    ts:
      type: integer
      title: Versioning timestamp
query: |
  // Fetch the siblings
  let siblings = (
    for t in ncbi_taxon
      filter t.id == @id
      filter t.created <= @ts AND t.expired >= @ts
      limit 1
      for parent in 1..1 outbound t ncbi_child_of_taxon
        filter parent.created <= @ts AND parent.expired >= @ts
        for child in 1..1 inbound parent ncbi_child_of_taxon
          filter child != t
          filter child.created <= @ts AND child.expired >= @ts
          sort child.scientific_name asc
          return child
  )
  // Apply limits to the results
  let limited = (
    for tax in siblings
      limit @offset, @limit
      return tax
  )
  return {total_count: COUNT(siblings), results: limited}
