# Get the array of direct descendants for any taxon
name: ncbi_taxon_get_children
params:
  type: object
  required: [key]
  properties:
    key:
      type: string
      title: Document key
      description: Key of the taxon vertex for which you want to find descendants
    limit:
      type: integer
      default: 20
      description: Maximum result limit
      maximum: 1000
    offset:
      type: integer
      default: 0
      description: Result offset for pagination
      maximum: 100000
    search_text:
      type: string
      description: Search scientific name
      default: ''
query: |
  let tax_id = CONCAT("ncbi_taxon/", @key)
  // Fetch the child IDs using the edge attributes
  let child_ids = (
      for e in ncbi_child_of_taxon
        filter e._to == tax_id
        return e._from
  )
  // Sort and filter the children
  let searched = (
      for tax in FULLTEXT(ncbi_taxon, "scientific_name", @search_text)
        filter tax._id in child_ids
        return tax
  )
  let not_searched = (
      for tax in ncbi_taxon
        filter tax._id in child_ids
        return tax
  )
  let filtered = @search_text ? searched : not_searched
  let results = (
    for tax in filtered
      sort tax.scientific_name asc
      limit @offset, @limit
      return tax
  )
  return {total_count: COUNT(filtered), results: results}
