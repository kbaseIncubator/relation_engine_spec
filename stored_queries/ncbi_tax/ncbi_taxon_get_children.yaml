# Get the array of direct descendants for any taxon
name: ncbi_taxon_get_children
params:
  type: object
  required: [id, ts]
  properties:
    id:
      type: string
      title: Document ID
      description: ID of the taxon vertex for which you want to find descendants
    limit:
      type: integer
      default: 20
      description: Maximum result limit
      maximum: 1000
    offset:
      type: integer
      default: 0
      description: Result offset for pagination
      maximum: 100000
    search_text:
      type: string
      description: Search scientific name
      default: ''
    ts:
      type: integer
      title: Versioning timestamp
    select:
      type: [array, "null"]
      items: {type: string}
      description: Taxon fields to keep in the results
      default: null
query: |
  // Fetch the child IDs using the edge attributes
  let children = (
      for parent in ncbi_taxon
        filter parent.id == @id
        filter parent.created <= @ts AND parent.expired >= @ts
        limit 1
        for tax in 1..1 inbound parent ncbi_child_of_taxon
            return tax
  )
  // Sort and filter the children
  // Should only get evaluated if search_text is truthy
  let searched = (
      for tax in FULLTEXT(ncbi_taxon, "scientific_name", @search_text)
        filter tax in children
        return tax
  )
  let filtered = @search_text ? searched : children
  let results = (
    for tax in filtered
      sort tax.scientific_name asc
      limit @offset, @limit
      return @select ? KEEP(tax, @select) : tax
  )
  return {total_count: COUNT(filtered), results: results}
